<!-- src/app/components/search-materials/search-materials.component.html -->
<mat-card class="search-card">
  <mat-card-header>
    <mat-card-title>Поиск металлических материалов</mat-card-title>
    <mat-card-subtitle>Ищем ключевые слова по всем текстовым колонкам</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <!-- Выбор таблиц для поиска -->
    <mat-form-field class="full-width" appearance="outline">
      <mat-label>Таблицы для поиска</mat-label>
      <mat-select [formControl]="tableCtrl" multiple (selectionChange)="onTableSelectionChange($event.value)">
        <mat-option *ngFor="let table of availableTables" [value]="table.name">
          {{ table.name }} ({{ table.columns }} колонок)
        </mat-option>
      </mat-select>
      <mat-hint *ngIf="searchAllTables">Поиск будет выполняться во всех таблицах</mat-hint>
      <mat-hint *ngIf="!searchAllTables">Выбрано таблиц: {{ selectedTables.length }}</mat-hint>
    </mat-form-field>

    <!-- Термины для поиска -->
    <mat-form-field class="full-width" appearance="outline">
      <mat-label>Термины для поиска</mat-label>
      <mat-chip-grid #chipGrid>
        <mat-chip-row *ngFor="let term of terms" (removed)="removeTerm(term)">
          {{ term }}
          <button matChipRemove [attr.aria-label]="'Удалить ' + term">
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip-row>
        <input matInput placeholder="Добавить термин..." [formControl]="termCtrl" [matChipInputFor]="chipGrid"
          [matChipInputSeparatorKeyCodes]="[13,188]" (matChipInputTokenEnd)="addTerm()" />
      </mat-chip-grid>
    </mat-form-field>

    <div class="actions">
      <button mat-raised-button color="primary" (click)="search()" [disabled]="isLoading || terms.length===0">
        <mat-icon>search</mat-icon>
        <span *ngIf="!isLoading">Найти</span>
        <mat-progress-spinner *ngIf="isLoading" diameter="20" mode="indeterminate">
        </mat-progress-spinner>
      </button>
    </div>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="error" class="error-card">
  <mat-card-content>
    <mat-icon color="warn">error</mat-icon>
    {{ error }}
  </mat-card-content>
</mat-card>

<mat-card *ngIf="results.length" class="results-card">
  <mat-card-header>
    <mat-card-title>Найдено совпадений: {{ results.length }}</mat-card-title>
  </mat-card-header>
  <mat-card-content class="table-container">
    <table mat-table [dataSource]="results" class="mat-elevation-z2">

      <!-- Таблица -->
      <ng-container matColumnDef="table">
        <th mat-header-cell *matHeaderCellDef>Таблица</th>
        <td mat-cell *matCellDef="let row">{{ row.table }}</td>
      </ng-container>

      <ng-container matColumnDef="column">
        <th mat-header-cell *matHeaderCellDef>Колонка</th>
        <td mat-cell *matCellDef="let row">{{ row.column }}</td>
      </ng-container>

      <!-- Динамические колонки из row_data -->
      <ng-container *ngFor="let col of displayedColumns.slice(2)" [matColumnDef]="col">
        <th mat-header-cell *matHeaderCellDef>{{ col }}</th>
        <td mat-cell *matCellDef="let row">
          <span [innerHTML]="row.row_data[col] | highlight:terms"></span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="data-row"></tr>
    </table>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="!isLoading && !results.length && !error" class="info-card">
  <mat-card-content>
    Введите термин(-ы) и нажмите «Найти» для отображения результатов.
  </mat-card-content>
</mat-card>