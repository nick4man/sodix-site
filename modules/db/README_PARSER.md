# Парсер сайта 23met.ru

Скрипт для рекурсивного парсинга сайта 23met.ru и сохранения данных о материалах в базу данных PostgreSQL.

## Описание

Скрипт `parser_23met.py` рекурсивно обходит страницы сайта 23met.ru, извлекает данные из таблиц с характеристиками материалов и сохраняет их в базу данных PostgreSQL.

### Извлекаемые данные

Скрипт извлекает только следующие поля из таблиц:
1. **Наименование** - название материала
2. **ГОСТ** - стандарт ГОСТ
3. **Класс** - класс арматуры (А500С, А240 и т.д.)
4. **Диаметр** - диаметр арматуры
5. **Номинальная масса 1 метра** - масса одного метра арматуры в кг/м

## Возможности

- Рекурсивный обход страниц сайта
- Извлечение данных из HTML-таблиц
- Автоматическое определение структуры таблиц
- Сохранение данных в структурированном виде
- Сохранение сырых данных таблиц в формате JSONB
- Обработка ошибок и повторные попытки запросов
- Защита от дублирования данных

## Структура базы данных

Скрипт создает следующие таблицы:

### material_categories
Хранит информацию о категориях материалов:
- `id` - уникальный идентификатор
- `name` - название категории
- `url` - URL страницы категории
- `parent_category` - родительская категория
- `created_at` - дата создания записи

### materials_23met
Хранит структурированные данные о материалах (только необходимые поля):
- `id` - уникальный идентификатор
- `наименование` - наименование материала
- `гост` - ГОСТ стандарт
- `класс` - класс арматуры (А500С, А240 и т.д.)
- `диаметр` - диаметр арматуры
- `номинальная_масса_1_метра` - номинальная масса одного метра (кг/м)
- `page_url` - URL страницы источника
- `created_at` - дата создания записи

### material_tables
Хранит полные данные таблиц:
- `id` - уникальный идентификатор
- `category` - категория
- `page_url` - URL страницы
- `table_index` - индекс таблицы на странице
- `headers` - заголовки таблицы (JSONB)
- `rows` - строки данных (JSONB)
- `created_at` - дата создания записи

## Установка зависимостей

Убедитесь, что установлены все необходимые зависимости:

```bash
cd /home/q/sodix-site/modules/db
pip install -r requirements.txt
# или если используется uv:
uv sync
```

Зависимости включают:
- `requests` - для HTTP-запросов
- `beautifulsoup4` - для парсинга HTML
- `lxml` - парсер для BeautifulSoup
- `psycopg2-binary` - драйвер PostgreSQL
- `python-dotenv` - для загрузки переменных окружения

## Настройка

1. Создайте файл `.env` в директории `modules/db/` (если его еще нет) со следующими переменными:

```env
DBHOST=localhost
DBNAME=your_database_name
DBUSER=your_username
DBPASS=your_password
```

2. Убедитесь, что база данных PostgreSQL запущена и доступна.

## Использование

### Базовое использование

Запуск с параметрами по умолчанию (парсинг арматуры А3):

```bash
python parser_23met.py
```

### С указанием стартовой страницы

```bash
python parser_23met.py https://23met.ru/spravka/armatura_a3/4
```

### С указанием стартовой страницы и категории

```bash
python parser_23met.py https://23met.ru/spravka/armatura_a3/4 "Арматура А3 диаметр 4"
```

## Параметры

Скрипт принимает следующие аргументы командной строки:

1. `start_url` (опционально) - URL стартовой страницы для парсинга. По умолчанию: `https://23met.ru/spravka/armatura_a3`
2. `category_name` (опционально) - название категории. По умолчанию: `"Арматура А3"`

## Особенности работы

- **Задержка между запросами**: 1 секунда (настраивается в переменной `DELAY_BETWEEN_REQUESTS`)
- **Повторные попытки**: до 3 попыток при ошибках запросов
- **Защита от дублирования**: используется `ON CONFLICT` для предотвращения дублирования записей
- **Рекурсивный обход**: автоматически находит и обрабатывает связанные страницы

## Примеры запросов к базе данных

### Получить все материалы

```sql
SELECT * FROM materials_23met 
ORDER BY диаметр, класс;
```

### Найти материалы по диаметру

```sql
SELECT наименование, гост, класс, диаметр, номинальная_масса_1_метра 
FROM materials_23met 
WHERE диаметр = '4'
ORDER BY класс;
```

### Найти материалы по классу (например, А500С)

```sql
SELECT наименование, гост, класс, диаметр, номинальная_масса_1_метра 
FROM materials_23met 
WHERE класс = 'А500С'
ORDER BY диаметр;
```

### Получить статистику по классам

```sql
SELECT класс, COUNT(*) as count 
FROM materials_23met 
WHERE класс IS NOT NULL
GROUP BY класс 
ORDER BY count DESC;
```

### Получить статистику по диаметрам

```sql
SELECT диаметр, COUNT(*) as count,
       AVG(номинальная_масса_1_метра) as средняя_масса
FROM materials_23met 
WHERE диаметр IS NOT NULL
GROUP BY диаметр 
ORDER BY диаметр::numeric;
```

### Получить все таблицы с определенной страницы

```sql
SELECT * FROM material_tables 
WHERE page_url = 'https://23met.ru/spravka/armatura_a3/4'
ORDER BY table_index;
```

## Обработка ошибок

Скрипт обрабатывает следующие ситуации:
- Ошибки подключения к базе данных
- Ошибки HTTP-запросов (с повторными попытками)
- Ошибки парсинга HTML
- Прерывание пользователем (Ctrl+C)

При возникновении ошибок скрипт выводит подробную информацию в консоль.

## Логирование

Скрипт выводит информацию о процессе парсинга:
- Начало парсинга каждой страницы
- Количество найденных таблиц
- Завершение парсинга страницы
- Итоговую статистику

## Примечания

- Скрипт автоматически создает необходимые таблицы при первом запуске
- Данные сохраняются с защитой от дублирования
- Рекурсивный обход может занять значительное время для больших сайтов
- Рекомендуется запускать скрипт в фоновом режиме для больших объемов данных

## Лицензия

Скрипт предназначен для использования в рамках проекта sodix-site.

